<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>我的3D照片圣诞树 - 电影级烟花版</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      font-family: 'Arial', sans-serif;
    }

    /* === 启动遮罩层 === */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.92); z-index: 2000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; text-align: center; transition: opacity 0.8s;
    }
    #start_btn {
      padding: 15px 40px; font-size: 18px; color: #444; background: #222; 
      border: 1px solid #444; border-radius: 50px; font-weight: bold; 
      pointer-events: none; transition: all 0.4s ease; text-transform: uppercase; margin-top: 20px;
    }
    #start_btn.ready {
      color: #000; background: #00ffff; border-color: #00ffff;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.6); cursor: pointer; pointer-events: auto;
    }

    /* === 悬浮摄像头窗口 === */
    #cam_window {
      position: absolute; bottom: 20px; right: 20px; width: 130px; height: 173px;
      z-index: 1000; background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 255, 255, 0.5); border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
      overflow: hidden; display: none;
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }
    #hand_canvas { width: 100%; height: 100%; transform: scaleX(-1); display: block; }
    #raw_video { display: none; }

    /* === 顶部控制按钮 === */
    .control-btn {
        position: absolute; top: 20px; width: 44px; height: 44px;
        background: rgba(255, 255, 255, 0.15); border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; z-index: 1500; transition: all 0.3s ease;
        backdrop-filter: blur(2px); border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .control-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .control-btn svg { width: 24px; height: 24px; fill: rgba(255, 255, 255, 0.9); transition: fill 0.3s ease; }
    .control-btn.off svg { fill: rgba(255, 255, 255, 0.3); }
    
    #cam_toggle { left: 20px; }
    #music_toggle { right: 20px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
  
  <script>
    function activateBtn() {
      const btn = document.getElementById('start_btn');
      if(btn) { btn.classList.add('ready'); btn.innerText = '欢迎来到Mia的圣诞树'; }
    }
    window.addEventListener('load', () => setTimeout(activateBtn, 1000));
  </script>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <div id="cam_toggle" class="control-btn" style="display:none;">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
  </div>
  <div id="music_toggle" class="control-btn" style="display:none;">
      <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
  </div>

  <div id="overlay">
    <div style="font-size: 2rem; color: #00ffff; text-shadow: 0 0 20px #00ffff;">CYBER CHRISTMAS</div>
    <div style="color: #888; margin-top: 10px;">Gesture Control System Loading...</div>
    <button id="start_btn">LOADING...</button>
  </div>

  <div id="cam_window"><canvas id="hand_canvas"></canvas></div>
  <video id="raw_video" playsinline webkit-playsinline></video>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

    // ================= 1. 场景与配置 =================
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.FogExp2(0x000000, 0.0015);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.useLegacyLights = false;
    document.body.appendChild(renderer.domElement);

    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 1;
    controls.maxDistance = 1000;
    controls.target.set(0, 30, 0); // 稍微抬高视点

    // 灯光
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2.0);
    hemiLight.position.set(0, 50, 0);
    scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
    dirLight.position.set(10, 20, 10);
    scene.add(dirLight);

    // ================= 2. 圣诞树与装饰 (保留核心) =================
    const treeRoot = new THREE.Group();
    scene.add(treeRoot);

    // 星空背景
    function createStarTexture() {
        const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255,255,255,1)');
        g.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
        return new THREE.CanvasTexture(canvas);
    }
    const starGeo = new THREE.BufferGeometry();
    const starCount = 1500;
    const starPos = new Float32Array(starCount * 3);
    for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random()-0.5)*1500;
    starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
    const starMat = new THREE.PointsMaterial({size: 2.5, map: createStarTexture(), transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false});
    const starMesh = new THREE.Points(starGeo, starMat);
    scene.add(starMesh);

    // 圣诞树结构与加载 (简化版，保留原逻辑)
    const floatingObjects = [];
    const gltfLoader = new GLTFLoader();
    
    // 加载豹警官 (树顶)
    gltfLoader.load('clawhauser.glb', (gltf) => {
        const model = gltf.scene; model.scale.set(10,10,10);
        model.rotation.set(-0.35, 0, 1.57);
        const root = new THREE.Group(); root.add(model);
        root.position.set(0, 30, 0);
        root.userData = { isTreeTop: true, originPos: root.position.clone(), originRot: root.rotation.clone(), originScale: root.scale.clone() };
        treeRoot.add(root); floatingObjects.push(root);
    }, undefined, () => {});

    // 加载礼物盒 (示例布局)
    const boxPositions = [[10,-32,59], [-10,-32,-14], [20,-32,0], [0,-32,20]];
    ['giftbox1.glb', 'giftbox2.glb'].forEach((name, i) => {
        gltfLoader.load(name, (gltf) => {
            const m = gltf.scene.clone(); m.scale.set(15,15,15);
            const g = new THREE.Group(); g.add(m);
            if(boxPositions[i]) g.position.set(...boxPositions[i]);
            g.userData = { pickType: 'gift', originPos: g.position.clone(), originRot: g.rotation.clone(), originScale: g.scale.clone() };
            treeRoot.add(g); floatingObjects.push(g);
        }, undefined, () => {});
    });

    // 彩球与照片占位
    const ballGeo = new THREE.SphereGeometry(0.3, 16, 16);
    const ballMat = new THREE.MeshStandardMaterial({color: 0xff0000, metalness: 0.8, roughness: 0.2});
    for(let i=0; i<300; i++) {
        const mesh = new THREE.Mesh(ballGeo, ballMat);
        const y = 30 - (i/300)*60;
        const r = (i/300)*20 + Math.random()*2;
        const theta = Math.random()*6.28;
        mesh.position.set(Math.cos(theta)*r, y, Math.sin(theta)*r);
        mesh.userData = { originPos: mesh.position.clone(), originRot: mesh.rotation.clone(), originScale: mesh.scale.clone() };
        treeRoot.add(mesh); floatingObjects.push(mesh);
    }

    // ================= 3. 高级粒子烟花系统 =================
    
    // 生成 Merry Christmas 文字纹理
    function createTextTexture(text) {
        const canvas = document.createElement('canvas');
        canvas.width = 1024; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        ctx.font = 'bold 80px "Arial", sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // 发光效果
        ctx.shadowColor = 'rgba(255, 215, 0, 1)';
        ctx.shadowBlur = 20;
        ctx.fillStyle = '#ffeb3b';
        ctx.fillText(text, 512, 128);
        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true;
        return tex;
    }
    const textTexture = createTextTexture("MERRY CHRISTMAS");

    // 烟花类
    class Firework {
        constructor(scene) {
            this.scene = scene;
            this.state = 'dead'; // dead, rising, exploding
            this.particles = null;
            this.geometry = null;
            this.material = null;
            this.textSprite = null;
            
            // 发射参数
            this.launchHeight = 60 + Math.random() * 20;
            this.launchPos = new THREE.Vector3(0, -30, 0);
            this.targetPos = new THREE.Vector3((Math.random()-0.5)*20, this.launchHeight, (Math.random()-0.5)*20);
            this.launchVel = new THREE.Vector3().subVectors(this.targetPos, this.launch